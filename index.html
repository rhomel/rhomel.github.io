<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>rhomel.github.io</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <button id="more">Add 5 More Weeks</button>
    <div>
      <table class="calendar">
        <tbody id="calendar">
        </tbody>
      </table>

      <table class="scale">
        <tbody id="scale">
        </tbody>
      </table>

      <table class="scale-minutes">
        <tbody id="scale-minutes">
        </tbody>
      </table>

    </div>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.1/moment.min.js"></script>
    <script>
      // convenience function for removing all children
      Element.prototype.removeAll = function() { 
        while(this.firstChild) { 
          this.removeChild(this.firstChild);
        } 
      };

      STATE = {
        "last_minute_offset_hours" : null,
        "weeks" : 5,
        "future_weeks" : 1
      };

      (function() {
        render(STATE.weeks, STATE.future_weeks, document.getElementById("calendar"));

        var more = document.getElementById("more");
        more.onclick = function() {
          STATE.weeks += 5;
          var cal = document.getElementById("calendar");
          cal.removeAll();
          render(STATE.weeks, STATE.future_weeks, cal);
        };
      })();

      function render(WEEKS, futureWeeks, calendar) {
        var now = moment();
        var today = moment([now.year(), now.month(), now.date()]);
        var firstDay = today.clone().subtract({days: today.day()});

        for (var week = WEEKS; week >= (-1 * futureWeeks); week--) {
          var date = firstDay.clone().subtract({weeks: week});
          addRow( calendar, date, today );
        }
      }

      function addRow( calendar, date, today ) {

        var tr = document.createElement('tr');

        for (var i = 0; i < 7; i++) {
          (function(){
            var td = document.createElement('td');
            tr.appendChild( td );

            var d = date.clone().add({days: i});

            var dateText = makeSpan( "date", d.date() );
            var monthText = makeSpan( "month-name", d.format("MMMM") );
            var epochText = makeSpan( "epoch", d.unix() );

            if ( d.date() == 1 ) {
              monthText.classList.add("month-first");
              td.classList.add("month-first");
            }

            if ( d.isSame(today, 'day') ) {
              td.classList.add("today");
            }
            else if ( d.isAfter(today, 'day') ) {
              td.classList.add("future");
            }

            td.appendChild( monthText );
            td.appendChild( dateText );
            td.appendChild( epochText );

            td.onclick = function() {
              var lastSelectedItem = td.parentNode.parentNode.querySelector(".selected");
              if (lastSelectedItem) {
                lastSelectedItem.classList.remove("selected")
              }

              td.classList.add("selected");
              showHourScale( d );

              if (STATE.last_minute_offset_hours) {
                showMinuteScale( d.clone().add({"hours" : STATE.last_minute_offset_hours}) );
              }
            };

            epochText.onclick = function(ev) {
              ev.stopPropagation();
            };
          })();

        }

        calendar.appendChild( tr );

      }

      function makeSpan( className, text ) {
        var span = document.createElement('span');
        span.appendChild( document.createTextNode( text ) );
        span.classList.add( className );
        return span;
      }

      function showHourScale( date ) {
        // center at midnight
        var d = moment([ date.year(), date.month(), date.date() ]);

        var scale = document.getElementById('scale');

        if (!scale) {
          console.log("Warning: couldn't find #scale");
          return;
        }

        // remove all children
        scale.removeAll();

        var tr = document.createElement('tr');
        var th = document.createElement('td');
        th.appendChild( makeSpan( "scale-header", d.format("MMMM Do YYYY") ) );
        tr.appendChild(th);
        scale.appendChild(tr);

        for (var i = 0; i < 25; i++) {

          (function() {
            var offset_hours = i;
            var offset = d.clone().add({hours: i});

            var tr = document.createElement('tr');
            var td = document.createElement('td');
            var hoursText = makeSpan( "hours", offset.format("H:mm") );
            var epochText = makeSpan( "epoch", offset.unix() );
            td.appendChild( hoursText );
            td.appendChild( blank() );
            td.appendChild( epochText );

            tr.appendChild(td);
            scale.appendChild(tr);

            td.onclick = function() {
              STATE.last_minute_offset_hours = offset_hours;
              showMinuteScale( offset );
            };

            epochText.onclick = function(ev) {
              ev.stopPropagation();
            };

          })();

        }

      }

      function showMinuteScale( date ) {
        var d = moment([ date.year(), date.month(), date.date(), date.hour() ]);

        var scale = document.getElementById('scale-minutes');

        if (!scale) {
          console.log("Warning: couldn't find #scale-minutes");
          return;
        }

        // remove all children
        scale.removeAll();

        var tr = document.createElement('tr');
        var th = document.createElement('td');
        th.appendChild( makeSpan( "scale-header", d.format("MMMM Do YYYY") ) );
        tr.appendChild(th);
        scale.appendChild(tr);

        for (var i = 0; i < 60; i++) {

          var tr = document.createElement('tr');
          var td = document.createElement('td');
          td.appendChild( makeSpan( "hours", d.format("H:mm") ) );
          td.appendChild( blank() );
          td.appendChild( makeSpan( "epoch", d.unix() ) );

          tr.appendChild(td);
          scale.appendChild(tr);

          d.add({minutes: 1});
        }

      }

      function blank() {
        return document.createTextNode(' ');
      }

    </script>
  </body>
</html>

